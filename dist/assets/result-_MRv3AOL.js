import{ak as f,Y as P,r as Q,Q as U,G as M,x as K,am as V,M as Y}from"./index-oyeJcrl9.js";const rt=l=>f.post("/api/system/microservice/resource/",l),at=l=>f.post("/api/system/microservice/create_mock/",l),nt=l=>f.get(`/api/system/microservice/get_mock/${l}/`),ct=l=>f.get(`/api/system/microservice/answer_status/${l}/`),it=l=>f.post("/api/system/microservice/answer_panel/",l),lt=l=>f.post(`/api/system/microservice/submit_answers/${l}/`),v=l=>f.post(`/api/system/microservice/scoring/${l}/`),z=l=>f.get(`/api/system/microservice/get_score/${l}/`),E=l=>f.get(`/api/system/microservice/get_score_repeat/${l}/`),ut=l=>f.get(`/api/system/microservice/get_past_scores/${l}/`),mt=(l,S)=>f.post("/api/system/microservice/grade_answer/",{sheet_id:l,question_id:S}),dt=l=>f.post("/api/system/microservice/create_mock_sheet/",l),N={10:"A+",9:"A",8:"A-","7.5":"B+",7:"B",6:"B-","5.5":"C+",5:"C",4:"C-",0:"F"},X={"Integrated Writing":[{key:"Content & Details Given",title:"内容与细节"},{key:"Grammar",title:"语法"},{key:"Structure/Flow",title:"结构与流畅度"}],"Academic discussion":[{key:"Contribution",title:"内容贡献"},{key:"Relevance",title:"相关性"},{key:"Structure/Flow",title:"结构与流畅度"},{key:"Grammar",title:"语法"}]},Z=[{key:["Fluency","Pronunciation"],title:"流利度"},{key:["Grammar","Vocabulary Usage"],title:"语法与词汇"},{key:"Content",title:"内容"},{key:"Coherence",title:"连贯性"}],W=[{type:"内容",id:"Content",style:{color:"#667085",background:"rgba(253, 212, 78, 0.3)"}},{type:"连贯性",id:"Coherence",style:{color:"#667085","text-decoration-line":"underline","text-decoration-color":"#667085"}},{type:"语法",id:"Grammar and Language Use",style:{color:"#667085","text-decoration-line":"underline","text-decoration-style":"dashed","text-decoration-color":"#C33473"}},{type:"优秀用句",id:"Good",style:{color:"#667085",background:"rgba(183, 217, 114, 0.3)"}}],tt=[{type:"内容与细节",id:"Content & Details Given",style:{color:"#667085",background:"rgba(253, 212, 78, 0.3)"}},{type:"结构与流畅度",id:"Structure/Flow",style:{color:"#667085","text-decoration-line":"underline","text-decoration-color":"#667085"}},{type:"语法",id:"Grammar",style:{color:"#667085","text-decoration-line":"underline","text-decoration-style":"dashed","text-decoration-color":"#C33473"}},{type:"优秀用句",id:"Good",style:{color:"#667085",background:"rgba(183, 217, 114, 0.3)"}}],et=[{type:"贡献度与相关性",id:["Contribution","Relevance"],style:{color:"#667085",background:"rgba(253, 212, 78, 0.3)"}},{type:"结构与流畅度",id:"Structure/Flow",style:{color:"#667085","text-decoration-line":"underline","text-decoration-color":"#667085"}},{type:"语法",id:"Grammar",style:{color:"#667085","text-decoration-line":"underline","text-decoration-style":"dashed","text-decoration-color":"#C33473"}},{type:"优秀用句",id:"Good",style:{color:"#667085",background:"rgba(183, 217, 114, 0.3)"}}],yt=P("result",()=>{const l=Q(!1),S=U(),a=M({loading:!0,title:"",level:"",footerActiveIndex:0,allData:[],type:"",aiComment:"",navData:[],questions_r:{},format_question:[],score_d:[],AnnotationData:[]}),D=M([]),j=t=>t.replace(/TPO\s?\d+/g,""),L=()=>{const{query:t}=S;if(t.type==="mock"){const c=D[a.footerActiveIndex],s=a.allData[a.footerActiveIndex];a.type=c.id,a.format_question=O(s.originData),a.questions_r=s.originData.questions_r,(a.type==="spoken"||a.type==="writing")&&(a.AnnotationData=s.formatAllData.allData.slice(1)),a.type==="hearing"&&(a.navData=s.list)}l.value=!l.value},F=async t=>{await V(5e3),await v(t);const c=await E(t);c.score===null?F(t):$(c)},T=t=>{const c=t==null?void 0:t.model_answer;if(!c)return{model_answer_content:{},model_answer:""};const s=typeof c=="string"?JSON.parse(c):c;if(s["General Feedback"]){const n=s["General Feedback"].split(/\n?(.+):\s/i).slice(1);s.format_G_F=new Array(n.length/2).fill(0).reduce((i,r,o)=>(i[n[o*2]]=n[o*2+1],i),{})}return s["Mind-Map"]&&(s.format_M_M=s["Mind-Map"].split(/\n/)),{model_answer_content:s,model_answer:c}},G=(t,c)=>{const s=JSON.parse(JSON.stringify(t));return s.forEach(n=>{const i=c==null?void 0:c.filter(r=>n.include.includes(r.name));n.total=0,n.count=0,i==null||i.forEach(r=>{n.total+=r.count,n.count+=r.sum}),n.isComputed=!0}),{list:s,tags:c==null?void 0:c.map(n=>({...n,name:n.name.replace(/^(阅读|听力)/g,"")}))}},I=(t,c)=>{const s=Object.values(t.score_d);if(c==="hearing"){const n=[{title:"基础题",include:["听力目的主旨题","听力内容主旨题","听力细节题"]},{title:"强化题",include:["听力推理题","听力句子功能题","听力连结内容题","听力组织结构题"]}],i=s.map(m=>{const e=m.find(p=>p.name.endsWith("Conversation2")||p.name.endsWith("Lecture3")||p.name.endsWith("Lecture4"))?2:1;return{title:"Section "+e,id:e}});let r=0;const o={layout:"col",name:"听力得分",mockScore:t.score,mockScoreTotal:t.max_score,level:x(t.score,t.max_score),aiComment:"",list:s.map((m,e)=>{const p=m.reduce((y,u)=>(u.name.includes("Conversation")?y.unshift(u):y.push(u),y),[]);return{...i[e],children:p.map((y,u)=>{var g,d;return{title:y.name.split(/\s/).slice(-1)[0],id:`${e}-${u}`,count:y.count,total:y.total,isComputed:m.score!==null,index:u+e*3,navNum:(d=(g=t.questions_r)==null?void 0:g.questions)==null?void 0:d[u+e*3].children.map(()=>r++)}})}})};return a.navData=o.list,{allData:[o,...i.map((m,e)=>{var u,g;const p=(u=s[e])==null?void 0:u.reduce((d,_)=>d+_.count,0),y=(g=s[e])==null?void 0:g.reduce((d,_)=>d+_.total,0);return{subtitle:m.title,layout:"row",level:x(p,y),name:"Raw Score",mockScore:p,mockScoreTotal:y,...G(n,t.tag_d[e+1]),aiComment:""}})],footerData:i}}else if(c==="spoken"){const n=s[0].map((r,o)=>({title:"Task "+r.name.split(/\s/).slice(-1)[0],id:`${o}`})),i=n.map((r,o)=>{var u,g;const{model_answer:m,model_answer_content:e}=T(t.questions_r.questions[o]),p=(u=e==null?void 0:e.Content)==null?void 0:u.filter(d=>Object.keys(d).length>0),y=W;return{layout:"col",name:r.title,level:x(t.questions_r.questions[o].score,t.questions_r.questions[o].max_score),mockScore:t.questions_r.questions[o].score,mockScoreTotal:t.questions_r.questions[o].max_score,aiComment:(g=e==null?void 0:e.format_G_F)==null?void 0:g.General,model_answer:m,model_answer_content:{...e,sent_back:p.map(d=>Object.keys(d).reduce((_,k)=>{var h;const q=(h=e["Sentence Feedback"][k].Type)==null?void 0:h.reduce((C,b)=>{var A;return{...(A=y.find(w=>w.id===b||w.id.includes(b)))==null?void 0:A.style}},{});return _[k]={...e["Sentence Feedback"][k],original:d[k],style:q,curStyle:{...q},aiStyle:{...q}},_},{}))},question:t.questions_r.questions[o],curIndex:o+1,length:t.questions_r.questions.length,ques_mark:W,list:Z.map(d=>{var k,q;const _=Array.isArray(d.key)?d.key.reduce((h,C)=>{var b;return Number((b=e==null?void 0:e.Grades)==null?void 0:b[C])+h},0):(k=e==null?void 0:e.Grades)==null?void 0:k[d.key];return{title:d.title,count:e?_/2:(q=e==null?void 0:e.Grades)==null?void 0:q[r.key],isComputed:(e==null?void 0:e.Status)==="OK",total:4}})}});return a.AnnotationData=i,{allData:[{layout:"col",name:"口语得分",level:x(t.score,n.length===4?30:t==null?void 0:t.max_score),mockScore:t==null?void 0:t.score,mockScoreTotal:n.length===4?30:t==null?void 0:t.max_score,list:t.questions_r.questions.map((r,o)=>({title:"Task "+r.order,id:o,isComputed:r.score!==null,count:r.score,total:r.max_score}))},...i],footerData:n}}else if(c==="writing"){const n=s.map((r,o)=>({title:Number(r[0].name.slice(-1))===1?"Integrated Writing":"Academic discussion",id:`${o}`})),i=n.map((r,o)=>{var u,g,d;const{model_answer:m,model_answer_content:e}=T(t.questions_r.questions[o]),p=(g=(u=e==null?void 0:e.Content)==null?void 0:u.filter)==null?void 0:g.call(u,_=>Object.keys(_).length>0),y=r.title==="Integrated Writing"?tt:et;return{layout:"col",name:r.title,ques_mark:y,mockScore:t.questions_r.questions[o].score,mockScoreTotal:t.questions_r.questions[o].max_score,level:x(t.questions_r.questions[o].score,t.questions_r.questions[o].max_score),aiComment:(d=e==null?void 0:e.format_G_F)==null?void 0:d.General,model_answer:m,model_answer_content:{...e,sent_back:p==null?void 0:p.map(_=>Object.keys(_).reduce((k,q)=>{var C;const h=(C=e["Sentence Feedback"][q].Type)==null?void 0:C.reduce((b,A)=>{var w;return{...(w=y.find(R=>R.id===A||R.id.includes(A)))==null?void 0:w.style}},{});return k[q]={...e["Sentence Feedback"][q],original:_[q],style:h,curStyle:{...h},aiStyle:{...h}},k},{}))},question:t.questions_r.questions[o],curIndex:o+1,length:t.questions_r.questions.length,list:X[r.title].map(_=>{var k,q;return{title:_.title,count:((k=e==null?void 0:e.Grades)==null?void 0:k[_.key])||0,isComputed:((q=e==null?void 0:e.Grades)==null?void 0:q[_.key])!==null,total:5}})}});return a.AnnotationData=i,{footerData:n,allData:[{layout:"col",name:"写作得分",mockScore:t.score,mockScoreTotal:n.length*15,level:x(t.score,n.length*15),list:t.questions_r.questions.map((r,o)=>({title:r.keywords.r===1200?"Integrated Writing":"Academic discussion",id:o,isComputed:r.score!==null,count:r.score,total:r.max_score})),aiComment:""},...i]}}else{const n=[{title:"基础题",include:["阅读词汇题","阅读指代题","阅读简化句子题","阅读细节题","阅读排除题"]},{title:"强化题",include:["阅读修辞目的题","阅读插入句子题","阅读推断题"]},{title:"文章小结题",include:["阅读文章内容小结题","阅读表格题"]}],i=s.map((r,o)=>({title:j(r[0].name),id:`${o}`}));return{footerData:i,allData:[{layout:"row",name:"阅读得分",mockScore:t.score,mockScoreTotal:t.max_score,level:x(t.score,t.max_score),aiComment:"",...G(n,t.tag_d.all)},...i.map((r,o)=>{var p,y;const m=(p=s[o])==null?void 0:p.reduce((u,g)=>u+g.count,0),e=(y=s[o])==null?void 0:y.reduce((u,g)=>u+g.total,0);return{layout:"row",name:"Raw Score",subtitle:r.title,mockScore:m,mockScoreTotal:e,level:x(m,e),aiComment:"",...G(n,t.tag_d[o+1])}})]}}},x=(t,c)=>{const s=t*(10/c),n=Object.keys(N).sort((r,o)=>r-o),i=n.find((r,o)=>s>=Number(r)&&s<Number(o===n.length-1?11:n[o+1]),0);return N[i]},O=t=>t.questions_r.questions.reduce((c,s)=>(c.push(...Array.isArray(s.children)&&s.children.length?s.children.map(n=>{var r;const i=(r=s.question_content)==null?void 0:r.split(/\\n/);return{...n,question_parent:{...s,original_question_content:i,question_content:i==null?void 0:i.map(o=>o.replaceAll(s.keywords.k,"")),question_title:s.question_title?s.question_title:"听力原文",children:null}}}):[]),c),[]),$=t=>{a.questions_r=t.questions_r,a.score_d=Object.values(t.score_d);const{query:c}=S;a.type=c.type,a.format_question=O(t),D.length=0;const s=I(t,c.type);D.push({title:"报告",id:"all"},...s.footerData),a.allData=s.allData,a.title=`${a.score_d[0][0].name.match(/^(TPO\s?\d+)/)[1]} 成绩单`,a.loading=!1},H=async t=>{var n;const{params:c}=S,s=[{title:"阅读",id:"read",layout:"row"},{title:"听力",id:"hearing",layout:"col"},{title:"口语",id:"spoken",layout:"col"},{title:"写作",id:"writing",layout:"table"}];a.questions_r=[],a.score_d=[],a.format_question=[],D.length=0,D[0]={title:"模考",id:"MixedAll"},D.push(...s),a.allData[0]={layout:"col",name:"总分",mockScore:t.score,mockScoreTotal:120,level:x(t.score,120),aiComment:"",list:s.map((i,r)=>({title:i.title,isComputed:!0,total:t.detail[r].max_score,count:t.detail[r].score}))};for(let i=0;i<s.length;i++){const r=await E(t.detail[i].sheet_id),o=I(r,s[i].id);a.allData.push({...o.allData[0],formatAllData:o,originData:r})}a.title=((n=Y("mixedExam-"+c.sheetId))==null?void 0:n.resource_name)||"模考成绩单",a.loading=!1},B=async t=>{const{query:c}=S;a.title="",a.level="",a.footerActiveIndex=0,a.allData=[],a.aiComment="",a.questions_r={},a.format_question=[],a.score_d=[],a.loading=!0,D.length=0,await v(t);const s=await z(t);if(s.score!==null){if(c.type==="mock"){H(s);return}$(s)}else F(t)},J=K(()=>a.allData[a.footerActiveIndex]);return{getExamResult:B,showHoverMark:(t,c,s,n)=>{var r;((r=a.allData.slice(1)[s])==null?void 0:r.model_answer_content.sent_back).map(o=>{Object.keys(o).map(m=>{n==="hover"?t===m?o[m].curStyle={...o[t].style,"font-weight":"700"}:o[m].curStyle={}:o[m].curStyle=o[m].style})})},curData:J,resultData:a,setShowAnswerHistoryDialog:L,showAnswerHistoryDialog:l,footerData:D}});export{ct as a,lt as b,v as c,z as d,it as e,mt as f,rt as g,at as h,dt as i,ut as j,nt as r,yt as u};
