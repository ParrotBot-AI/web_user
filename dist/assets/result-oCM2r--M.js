import{ak as D,Z as z,r as Q,S as V,J as K,z as Z,am as X,x as Y}from"./index-vdyT4Arr.js";const nt=l=>D.post("/api/system/microservice/resource/",l),ct=l=>D.post("/api/system/microservice/create_mock/",l),lt=l=>D.get(`/api/system/microservice/get_mock/${l}/`),ut=l=>D.get(`/api/system/microservice/answer_status/${l}/`),mt=l=>D.post("/api/system/microservice/answer_panel/",l),dt=l=>D.post(`/api/system/microservice/submit_answers/${l}/`),v=l=>D.post(`/api/system/microservice/scoring/${l}/`),tt=l=>D.get(`/api/system/microservice/get_score/${l}/`),W=l=>D.get(`/api/system/microservice/get_score_repeat/${l}/`),yt=l=>D.get(`/api/system/microservice/get_past_scores/${l}/`),pt=(l,G)=>D.post("/api/system/microservice/grade_answer/",{sheet_id:l,question_id:G}),gt=l=>D.post("/api/system/microservice/create_mock_sheet/",l),j={10:"A+",9:"A",8:"A-","7.5":"B+",7:"B",6:"B-","5.5":"C+",5:"C",4:"C-",0:"F"},et={"Integrated Writing":[{key:"Content & Details Given",title:"内容与细节"},{key:"Grammar",title:"语法"},{key:"Structure/Flow",title:"结构与流畅度"}],"Academic discussion":[{key:"Contribution",title:"内容贡献"},{key:"Relevance",title:"相关性"},{key:"Structure/Flow",title:"结构与流畅度"},{key:"Grammar",title:"语法"}]},ot=[{key:["Fluency","Pronunciation"],title:"流利度"},{key:["Grammar","Vocabulary Usage"],title:"语法与词汇"},{key:"Content",title:"内容"},{key:"Coherence",title:"连贯性"}],L=[{type:"内容",id:"Content",style:{color:"#667085",background:"rgba(253, 212, 78, 0.3)"}},{type:"连贯性",id:"Coherence",style:{color:"#667085","text-decoration-line":"underline","text-decoration-color":"#667085"}},{type:"语法",id:"Grammar and Language Use",style:{color:"#667085","text-decoration-line":"underline","text-decoration-style":"dashed","text-decoration-color":"#C33473"}},{type:"优秀用句",id:"Good",style:{color:"#667085",background:"rgba(183, 217, 114, 0.3)"}}],st=[{type:"内容与细节",id:"Content & Details Given",style:{color:"#667085",background:"rgba(253, 212, 78, 0.3)"}},{type:"结构与流畅度",id:"Structure/Flow",style:{color:"#667085","text-decoration-line":"underline","text-decoration-color":"#667085"}},{type:"语法",id:"Grammar",style:{color:"#667085","text-decoration-line":"underline","text-decoration-style":"dashed","text-decoration-color":"#C33473"}},{type:"优秀用句",id:"Good",style:{color:"#667085",background:"rgba(183, 217, 114, 0.3)"}}],at=[{type:"贡献度与相关性",id:["Contribution","Relevance"],style:{color:"#667085",background:"rgba(253, 212, 78, 0.3)"}},{type:"结构与流畅度",id:"Structure/Flow",style:{color:"#667085","text-decoration-line":"underline","text-decoration-color":"#667085"}},{type:"语法",id:"Grammar",style:{color:"#667085","text-decoration-line":"underline","text-decoration-style":"dashed","text-decoration-color":"#C33473"}},{type:"优秀用句",id:"Good",style:{color:"#667085",background:"rgba(183, 217, 114, 0.3)"}}],qt=z("result",()=>{const l=Q(!1),G=V(),s=K({loading:!0,title:"",level:"",footerActiveIndex:0,allData:[],type:"",aiComment:"",navData:[],questions_r:{},format_question:[],score_d:[],AnnotationData:[]}),C=K([]),H=e=>e.replace(/TPO\s?\d+/g,""),J=()=>{const{query:e}=G;if(e.type==="mock"){const i=C[s.footerActiveIndex],o=s.allData[s.footerActiveIndex];s.type=i.id,s.format_question=w(o.originData),s.questions_r=o.originData.questions_r,(s.type==="spoken"||s.type==="writing")&&(s.AnnotationData=o.formatAllData.allData.slice(1)),s.type==="hearing"&&(s.navData=o.list)}l.value=!l.value},I=async e=>{await X(5e3),await v(e);const i=await W(e);i.score===null?I(e):M(i)},$=e=>{const i=e==null?void 0:e.model_answer;if(!i)return{model_answer_content:{},model_answer:""};const o=typeof i=="string"?JSON.parse(i):i;if(o["General Feedback"]){const u=o["General Feedback"].split(/\n?(.+):\s/i).slice(1);o.format_G_F=new Array(u.length/2).fill(0).reduce((p,n,a)=>(p[u[a*2]]=u[a*2+1],p),{})}return o["Mind-Map"]&&(o.format_M_M=o["Mind-Map"].split(/\n/)),{model_answer_content:o,model_answer:i}},T=(e,i)=>{const o=JSON.parse(JSON.stringify(e));return o.forEach(u=>{const p=i==null?void 0:i.filter(n=>u.include.includes(n.name));u.total=0,u.count=0,p==null||p.forEach(n=>{u.total+=n.count,u.count+=n.sum}),u.isComputed=!0}),{list:o,tags:i==null?void 0:i.map(u=>({...u,name:u.name.replace(/^(阅读|听力)/g,"")}))}},R=(e,i)=>{var u,p;const o=Object.values(e.score_d);if(i==="hearing"){const n=[{title:"基础题",include:["听力目的主旨题","听力内容主旨题","听力细节题"]},{title:"强化题",include:["听力推理题","听力句子功能题","听力连结内容题","听力组织结构题"]}],a=o.map(c=>{const m=c.find(t=>t.name.endsWith("Conversation2")||t.name.endsWith("Lecture3")||t.name.endsWith("Lecture4"))?2:1;return{title:"Section "+m,id:m}});let d=0;const r={layout:"col",name:"听力得分",mockScore:e.score,mockScoreTotal:e.max_score,level:x(e.score,e.max_score),aiComment:"",list:o.map((c,m)=>{const t=c.reduce((y,g)=>(g.name.includes("Conversation")?y.unshift(g):y.push(g),y),[]);return{...a[m],children:t.map((y,g)=>{var q,h;return{title:y.name.split(/\s/).slice(-1)[0],id:`${m}-${g}`,count:y.count,total:y.total,isComputed:c.score!==null,index:g+m*3,navNum:(h=(q=e.questions_r)==null?void 0:q.questions)==null?void 0:h[g+m*3].children.map(()=>d++)}})}})};return s.navData=r.list,{allData:[r,...a.map((c,m)=>{var g,q;const t=(g=o[m])==null?void 0:g.reduce((h,k)=>h+k.count,0),y=(q=o[m])==null?void 0:q.reduce((h,k)=>h+k.total,0);return{subtitle:c.title,layout:"row",level:x(t,y),name:"Raw Score",mockScore:t,mockScoreTotal:y,...T(n,e.tag_d[m+1]),aiComment:""}})],footerData:a}}else if(i==="spoken"){const n=o[0].map((r,c)=>({title:"Task "+r.name.split(/\s/).slice(-1)[0],id:`${c}`})),a=n.map((r,c)=>{var q,h;const{model_answer:m,model_answer_content:t}=$(e.questions_r.questions[c]),y=(q=t==null?void 0:t.Content)==null?void 0:q.filter(k=>Object.keys(k).length>0),g=L;return{layout:"col",name:r.title,level:x(e.questions_r.questions[c].score,e.questions_r.questions[c].max_score),mockScore:(t==null?void 0:t.Status)==="OK"?e.questions_r.questions[c].score:"Na",mockScoreTotal:e.questions_r.questions[c].max_score,aiComment:(t==null?void 0:t.Status)==="OK"?(h=t==null?void 0:t.format_G_F)==null?void 0:h.General:(t==null?void 0:t.msg)==="用量已超使用上限制"?"🔒您的今日免费批改次数已用尽，如需批改，请前往价格页购买。":t==null?void 0:t.msg,model_answer:m,model_answer_content:{...t,sent_back:y==null?void 0:y.map(k=>Object.keys(k).reduce((_,S)=>{var b;const f=(b=t["Sentence Feedback"][S].Type)==null?void 0:b.reduce((O,F)=>{var A;return{...(A=g.find(N=>N.id===F||N.id.includes(F)))==null?void 0:A.style}},{});return _[S]={...t["Sentence Feedback"][S],original:k[S],style:f,curStyle:{...f},aiStyle:{...f}},_},{}))},question:e.questions_r.questions[c],curIndex:c+1,length:e.questions_r.questions.length,ques_mark:L,list:ot.map(k=>{var S,f,b;const _=Array.isArray(k.key)?k.key.reduce((O,F)=>{var A;return Number((A=t==null?void 0:t.Grades)==null?void 0:A[F])+O},0):(S=t==null?void 0:t.Grades)==null?void 0:S[k.key];return{title:k.title,count:(t==null?void 0:t.Status)==="OK"?t?_/2:(f=t==null?void 0:t.Grades)==null?void 0:f[r.key]:"Na",isComputed:((b=t==null?void 0:t.Grades)==null?void 0:b[k.key])!==null,total:4}})}});s.AnnotationData=a;const d=a[0];return{allData:[{layout:"col",name:"口语得分",level:x(e.score,n.length===4?30:e==null?void 0:e.max_score),mockScore:((u=d.model_answer_content)==null?void 0:u.Status)==="OK"?e==null?void 0:e.score:"Na",mockScoreTotal:n.length===4?30:e==null?void 0:e.max_score,list:e.questions_r.questions.map((r,c)=>{var m;return{title:"Task "+r.order,id:c,isComputed:r.score!==null,count:((m=d.model_answer_content)==null?void 0:m.Status)==="OK"?r.score:"Na",total:r.max_score}})},...a],footerData:n}}else if(i==="writing"){const n=o.map((r,c)=>({title:Number(r[0].name.slice(-1))===1?"Integrated Writing":"Academic discussion",id:`${c}`})),a=n.map((r,c)=>{var q,h,k;const{model_answer:m,model_answer_content:t}=$(e.questions_r.questions[c]),y=(h=(q=t==null?void 0:t.Content)==null?void 0:q.filter)==null?void 0:h.call(q,_=>Object.keys(_).length>0),g=r.title==="Integrated Writing"?st:at;return{layout:"col",name:r.title,ques_mark:g,mockScore:(t==null?void 0:t.Status)==="OK"?e.questions_r.questions[c].score:"Na",mockScoreTotal:e.questions_r.questions[c].max_score,level:x(e.questions_r.questions[c].score,e.questions_r.questions[c].max_score),aiComment:(t==null?void 0:t.Status)==="OK"?(k=t==null?void 0:t.format_G_F)==null?void 0:k.General:(t==null?void 0:t.msg)==="用量已超使用上限制"?"🔒您的今日免费批改次数已用尽，如需批改，请前往价格页购买。":t==null?void 0:t.msg,model_answer:m,model_answer_content:{...t,sent_back:y==null?void 0:y.map(_=>Object.keys(_).reduce((S,f)=>{var O;const b=(O=t["Sentence Feedback"][f].Type)==null?void 0:O.reduce((F,A)=>{var N;return{...(N=g.find(E=>E.id===A||E.id.includes(A)))==null?void 0:N.style}},{});return S[f]={...t["Sentence Feedback"][f],original:_[f],style:b,curStyle:{...b},aiStyle:{...b}},S},{}))},question:e.questions_r.questions[c],curIndex:c+1,length:e.questions_r.questions.length,list:et[r.title].map(_=>{var S,f;return{title:_.title,count:(t==null?void 0:t.Status)==="OK"?(S=t==null?void 0:t.Grades)==null?void 0:S[_.key]:"Na",isComputed:((f=t==null?void 0:t.Grades)==null?void 0:f[_.key])!==null,total:5}})}}),d=a[0];return s.AnnotationData=a,{footerData:n,allData:[{layout:"col",name:"写作得分",mockScore:((p=d.model_answer_content)==null?void 0:p.Status)==="OK"?e.score:"Na",mockScoreTotal:n.length*15,level:x(e.score,n.length*15),list:e.questions_r.questions.map((r,c)=>{var m;return{title:r.keywords.r===1200?"Integrated Writing":"Academic discussion",id:c,isComputed:r.score!==null,count:((m=d.model_answer_content)==null?void 0:m.Status)==="OK"?r.score:"Na",total:r.max_score}}),aiComment:""},...a]}}else{const n=[{title:"基础题",include:["阅读词汇题","阅读指代题","阅读简化句子题","阅读细节题","阅读排除题"]},{title:"强化题",include:["阅读修辞目的题","阅读插入句子题","阅读推断题"]},{title:"文章小结题",include:["阅读文章内容小结题","阅读表格题"]}],a=o.map((d,r)=>({title:H(d[0].name),id:`${r}`}));return{footerData:a,allData:[{layout:"row",name:"阅读得分",mockScore:e.score,mockScoreTotal:e.max_score,level:x(e.score,e.max_score),aiComment:"",...T(n,e.tag_d.all)},...a.map((d,r)=>{var t,y;const c=(t=o[r])==null?void 0:t.reduce((g,q)=>g+q.count,0),m=(y=o[r])==null?void 0:y.reduce((g,q)=>g+q.total,0);return{layout:"row",name:"Raw Score",subtitle:d.title,mockScore:c,mockScoreTotal:m,level:x(c,m),aiComment:"",...T(n,e.tag_d[r+1])}})]}}},x=(e,i)=>{const o=e*(10/i),u=Object.keys(j).sort((n,a)=>n-a),p=u.find((n,a)=>o>=Number(n)&&o<Number(a===u.length-1?11:u[a+1]),0);return j[p]},w=e=>e.questions_r.questions.reduce((i,o)=>(i.push(...Array.isArray(o.children)&&o.children.length?o.children.map(u=>{var n;const p=(n=o.question_content)==null?void 0:n.split(/\\n/);return{...u,question_parent:{...o,original_question_content:p,question_content:p==null?void 0:p.map(a=>a.replaceAll(o.keywords.k,"")),question_title:o.question_title?o.question_title:"听力原文",children:null}}}):[]),i),[]),M=e=>{s.questions_r=e.questions_r,s.score_d=Object.values(e.score_d);const{query:i}=G;s.type=i.type,s.format_question=w(e),C.length=0;const o=R(e,i.type);C.push({title:"报告",id:"all"},...o.footerData),s.allData=o.allData,s.title=`${s.score_d[0][0].name.match(/^(TPO\s?\d+)/)[1]} 成绩单`,s.loading=!1},B=async e=>{var u,p,n;const{params:i}=G,o=[{title:"阅读",id:"read",layout:"row"},{title:"听力",id:"hearing",layout:"col"},{title:"口语",id:"spoken",layout:"col"},{title:"写作",id:"writing",layout:"table"}];s.questions_r=[],s.score_d=[],s.format_question=[],C.length=0,C[0]={title:"模考",id:"MixedAll"},C.push(...o),s.allData[0]={layout:"col",name:"总分",mockScore:e.score,mockScoreTotal:120,level:x(e.score,120),aiComment:"",list:o.map((a,d)=>{var r;return{title:a.title,isComputed:!0,total:30,count:(r=e.detail[d])==null?void 0:r.score}})};for(let a=0;a<o.length;a++)if((u=e.detail[a])!=null&&u.sheet_id){const d=await W((p=e.detail[a])==null?void 0:p.sheet_id),r=R(d,o[a].id);s.allData.push({...r.allData[0],formatAllData:r,originData:d})}s.title=((n=Y("mixedExam-"+i.sheetId))==null?void 0:n.resource_name)||"模考成绩单",s.loading=!1},P=async e=>{const{query:i}=G;s.title="",s.level="",s.footerActiveIndex=0,s.allData=[],s.aiComment="",s.questions_r={},s.format_question=[],s.score_d=[],s.loading=!0,C.length=0,await v(e);const o=await tt(e);if(o.score!==null){if(i.type==="mock"){B(o);return}M(o)}else I(e)},U=Z(()=>s.allData[s.footerActiveIndex]);return{getExamResult:P,showHoverMark:(e,i,o,u)=>{var n;((n=s.allData.slice(1)[o])==null?void 0:n.model_answer_content.sent_back).map(a=>{Object.keys(a).map(d=>{u==="hover"?e===d?a[d].curStyle={...a[e].style,"font-weight":"700"}:a[d].curStyle={}:a[d].curStyle=a[d].style})})},curData:U,resultData:s,setShowAnswerHistoryDialog:J,showAnswerHistoryDialog:l,footerData:C}});export{ut as a,dt as b,v as c,tt as d,mt as e,pt as f,nt as g,ct as h,gt as i,yt as j,lt as r,qt as u};
